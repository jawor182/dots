#!/bin/bash

path="$HOME/.local/share/mpvq"
playlist="$path/playlist.m3u"
lockfile="$path/mpvq.lock"
ipc_socket="/tmp/mpvsocket"

[ ! -d "$path" ] && mkdir -p "$path"
[ ! -f "$playlist" ] && touch "$playlist"

# Function to remove duplicates from the playlist
deduplicate() {
    if [ -f "$playlist" ]; then
        awk '!a[$0]++' "$playlist" > "$playlist.tmp"
        mv "$playlist.tmp" "$playlist"
        echo "Duplicates removed from playlist."
    fi
}

add() {
    local file_or_url="$2"

    # Always append to the playlist file for persistence
    echo "$file_or_url" >>"$playlist"
    deduplicate
    echo "Added to playlist file: $file_or_url"

    # If mpv is running, check if it's already in the playlist before adding
    if [ -S "$ipc_socket" ]; then
        # Get current MPV playlist
        local current_playlist
        current_playlist=$(echo '{ "command": ["get_property", "playlist"] }' | socat - "$ipc_socket" | jq -r '.data[].filename')

        # Check if file_or_url is already in MPV's playlist
        if echo "$current_playlist" | grep -Fxq "$file_or_url"; then
            echo "Item already in MPV playlist, not adding again."
        else
            echo '{ "command": ["loadfile", "'"$file_or_url"'", "append"] }' | socat - "$ipc_socket"
            echo "Also added via IPC for immediate playback."
        fi
    fi
}


addclip() {
    local clipfile=$(xclip -o -selection clipboard)
    if echo "$clipfile" | grep -Eq '^https?://'; then
        # Always append to the playlist file for persistence
        echo "$clipfile" >>"$playlist"
        deduplicate
        echo "Added from clipboard to playlist file."

        # If mpv is running, check if it's already in the playlist before adding
        if [ -S "$ipc_socket" ]; then
            local current_playlist
            current_playlist=$(echo '{ "command": ["get_property", "playlist"] }' | socat - "$ipc_socket" | jq -r '.data[].filename')

            if echo "$current_playlist" | grep -Fxq "$clipfile"; then
                echo "Clipboard URL already in MPV playlist, not adding again."
            else
                echo '{ "command": ["loadfile", "'"$clipfile"'", "append"] }' | socat - "$ipc_socket"
                echo "Also added from clipboard via IPC for immediate playback."
            fi
        fi
    else
        echo "Clipboard does not contain a valid URL."
    fi
}


show() {
    if [ ! -s "$playlist" ]; then
        echo "Queue is empty."
    else
        cat "$playlist"
    fi
}

play() {
    exec 200>"$lockfile"
    flock -n 200 || { echo "Another mpvq instance is already running!"; exit 1; }

    setsid -f mpv \
        --playlist="$playlist" \
        --player-operation-mode=pseudo-gui \
        --input-ipc-server="$ipc_socket" \
        --script="$HOME/.config/mpv/scripts/mpvq-live-sync.lua" \
        --script="/usr/lib/mpv-mpris/mpris.so"
}

case "$1" in
    add)
        [ -z "$2" ] && { echo "Usage: mpvq add <file-or-url>"; exit 1; }
        add "$@"
        ;;
    show)
        show
        ;;
    play)
        play
        ;;
    addclip)
        addclip
        ;;
    deduplicate)
        deduplicate
        ;;
    *)
        echo "Usage: mpvq {add|show|play|deduplicate|addclip}"
        exit 1
        ;;
esac
