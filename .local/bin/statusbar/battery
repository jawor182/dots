#!/bin/sh

# TODO: :
# - [ ] battery indicator for both batteries displaying status and correlating icon
# - [ ] on click - how long will the battery last or until charged
# - [ ] on click - open file to edit
# Battery status info options :
# 󰁹 - > 95
# 󰂀 - > 70
# 󰁽 - > 50
# 󰁼 - > 25
# 󰂃 - < 20
# 󰢜 - chargin < 25
# 󰂆 - chargin > 25
# 󰢝 - chargin > 50
# 󰢞 - chargin > 75
# 󰂅 - chargin > 95
# 󱧥 - not charging
# 󰂑 - unknown

case $BLOCK_BUTTON in
1)
    # Show battery info and estimated remaining time
    notify-send "󰁹 Battery Info" "$(acpi -b | sed 's/, /\n/g')"
    ;;
2)
    # Show how long battery will last / until charged
    time_left=$(acpi -b | awk -F', ' '{print $3}' | grep -Eo '[0-9:]+')
    notify-send "󰂑 Battery Time" "${time_left:-Unknown}"
    ;;
4) brightnessctl set +10% ;;
5) brightnessctl set 10%- ;;
6) setsid -f "$TERMINAL" -e "$EDITOR" "$0" ;;
esac

# Function to map percentage + status to Nerd Font icon
get_icon() {
    status=$1
    cap=$2

    case "$status" in
    "Charging")
        if [ "$cap" -lt 25 ]; then
            echo "󰢜"
        elif [ "$cap" -lt 50 ]; then
            echo "󰂆"
        elif [ "$cap" -lt 75 ]; then
            echo "󰢝"
        elif [ "$cap" -lt 95 ]; then
            echo "󰢞"
        else
            echo "󰂅"
        fi
        ;;
    "Discharging")
        if [ "$cap" -lt 20 ]; then
            echo "󰂃"
        elif [ "$cap" -lt 25 ]; then
            echo "󰁼"
        elif [ "$cap" -lt 50 ]; then
            echo "󰁽"
        elif [ "$cap" -lt 70 ]; then
            echo "󰂀"
        elif [ "$cap" -lt 95 ]; then
            echo "󰁹"
        else
            echo "󰁹"
        fi
        ;;
    "Full") echo "󰁹" ;;
    "Not charging") echo "󱧥" ;;
    *) echo "󰂑" ;;
    esac
}

# Gather info
output=""
for battery in /sys/class/power_supply/BAT?*; do
    [ -d "$battery" ] || continue

    status=$(cat "$battery/status" 2>/dev/null)
    cap=$(cat "$battery/capacity" 2>/dev/null)
    icon=$(get_icon "$status" "$cap")

    # Get estimated time remaining (from acpi)
    time_rem=$(acpi -b | grep "$(basename "$battery")" | awk -F', ' '{print $3}' | grep -Eo '[0-9:]+')
    [ -n "$time_rem" ] && time_str=" ($time_rem)" || time_str=""

    output="$output$icon $cap%$time_str  "
done

# Print final output
printf "%s\n" "$output"
